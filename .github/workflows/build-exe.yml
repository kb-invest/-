name: Build EXE Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        pip install pyinstaller pywin32
        npm install
        
    - name: Build frontend
      run: npm run build
      
    - name: Build EXE
      run: |
        pyinstaller --name="부동산앱_설치" --onefile --windowed --add-data="backend;backend" --add-data="templates;templates" --add-data="dist;dist" installer.py
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: installer-exe
        path: dist/부동산앱_설치.exe
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/부동산앱_설치.exe
        body: |
          ## 상업용 부동산 제안서 생성 시스템 - 설치 프로그램
          
          ### 다운로드
          - `부동산앱_설치.exe` 파일을 다운로드하여 실행하세요.
          
          ### 설치 방법
          1. `부동산앱_설치.exe` 다운로드
          2. 더블클릭하여 실행
          3. 자동 설치 진행
          4. 바탕화면 아이콘으로 실행!
          
          ### 시스템 요구사항
          - Windows 10/11
          - Python 3.8 이상 (https://python.org/downloads)
          
          Made with ❤️ by Rick for 비크님
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
